# 数据库导出到 Excel 功能

## 功能概述

本功能可以将数据库中的所有爬虫数据导出到 Excel 表格文件中，数据按照日期倒序排列（最新的数据在最前面）。

## 主要特性

- **完整导出**：导出数据库中的所有数据，不进行重复检查
- **日期排序**：按照 date 字段倒序排列，最新数据在最前面
- **智能日期解析**：支持多种日期格式的排序
- **自动文件命名**：文件名格式为 `表格_YYYY-MM-DD_HH-MM-SS.xlsx`
- **美观格式**：包含表头样式、自动筛选、冻结首行等功能

## 数据字段

导出的 Excel 文件包含以下字段：

| 字段名   | 说明             | 宽度 |
| -------- | ---------------- | ---- |
| 序号     | 自动生成的序号   | 8    |
| ID       | 数据库主键 ID    | 8    |
| 类型     | 资源类型         | 15   |
| 标题     | 资源标题         | 50   |
| 下载链接 | Torrent 下载链接 | 60   |
| 磁力链接 | 磁力链接         | 80   |
| 大小     | 文件大小         | 15   |
| 日期     | 发布日期         | 15   |
| 创建时间 | 数据入库时间     | 20   |

## 使用方法

### 开发环境运行

```bash
# 直接运行导出
npm run export:excel

# 或者使用pnpm
pnpm export:excel
```

### 生产环境运行

```bash
# 编译并运行
npm run prod:export:excel

# 或者使用pnpm
pnpm prod:export:excel
```

### 直接运行 TypeScript 文件

```bash
ts-node export_db_to_excel.ts
```

## 输出示例

运行成功后，会在项目根目录生成类似以下名称的 Excel 文件：

```
表格_2024-01-15_14-30-25.xlsx
```

## 数据库配置

程序使用以下数据库配置（与 main_sql.ts 保持一致）：

```typescript
const config: DatabaseConfig = {
  host: "localhost",
  port: 3306,
  user: "root",
  password: "123456",
  database: "scraper_db",
};
```

如需修改数据库配置，请编辑 `export_db_to_excel.ts` 文件中的 `config` 对象。

## 排序逻辑

数据按照以下优先级进行倒序排列：

1. **日期字段解析**：

   - `YYYY-MM-DD` 格式：直接解析
   - `MM-DD` 格式：补充当前年份
   - `M/D` 格式：转换为标准格式并补充年份
   - 其他格式：使用创建时间排序

2. **创建时间**：作为次要排序条件

## 注意事项

1. **数据库连接**：确保 MySQL 服务正在运行且配置正确
2. **权限要求**：确保数据库用户有读取权限
3. **文件权限**：确保程序有写入当前目录的权限
4. **内存使用**：大量数据导出时可能占用较多内存
5. **文件覆盖**：每次运行都会生成新文件，不会覆盖已有文件

## 错误处理

程序包含完整的错误处理机制：

- 数据库连接失败
- 数据查询错误
- Excel 文件创建失败
- 文件写入权限问题

所有错误都会在控制台显示详细信息。

## 性能优化

- 使用数据库连接池提高查询效率
- 一次性查询所有数据，减少数据库交互
- 使用流式写入 Excel 文件，适合大数据量导出

## 扩展功能

如需添加更多功能，可以考虑：

- 添加日期范围筛选
- 支持按类型筛选导出
- 添加数据统计信息
- 支持多种导出格式（CSV、JSON 等）

